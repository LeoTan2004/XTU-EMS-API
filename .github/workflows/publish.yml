name: Publish xtu-ems-api

on:
    workflow_dispatch:
    release:
        types: [published]

jobs:
    publish:
        runs-on: ubuntu-22.04
        permissions:
            contents: read
            packages: write

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install build tooling
              run: |
                  python -m pip install --upgrade pip
                  pip install "build<2" "twine>=6.2.0,<7"

            - name: Build distribution
              run: python -m build

            - name: Check package metadata
              run: twine check dist/*

            - name: Verify version matches tag
              if: github.event_name == 'release'
              run: |
                  TAG=${GITHUB_REF_NAME#v}
                  PKG_VERSION=$(python - << 'EOF'
                  import tomllib
                  with open("pyproject.toml", "rb") as f:
                      print(tomllib.load(f)["project"]["version"])
                  EOF
                  )
                  test "$TAG" = "$PKG_VERSION"

            - name: Publish to GitHub Packages
              env:
                  TWINE_USERNAME: ${{ github.actor }}
                  TWINE_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
                  TWINE_REPOSITORY_URL: https://pypi.pkg.github.com/${{ github.repository_owner }}
              run: twine upload --skip-existing dist/*
